# Sync Plan — 2026-02-25

**Purpose**: Capture all analysis from the bootstrap session so the sync can be resumed without re-doing research.

**Status**: Sync NOT started yet. `origin/main` already updated to `9e806d7`. Merge into `main_embed` pending.

---

## Delta Summary

- **Range**: `ce4f005` → `9e806d7`
- **Commits**: 276 total (148 non-merge)
- **Files changed**: 125, +2,863 / −16,962 lines
- **New upstream tags**: v0.1.4, v0.1.4.post1, v0.1.4.post2

## Dry-Run Merge Result (3 conflicts)

```
CONFLICT (content): nanobot/channels/manager.py
CONFLICT (content): nanobot/cli/commands.py
CONFLICT (content): pyproject.toml
```

Auto-merged (no conflict): `schema.py`, `registry.py`, `README.md`, `shell.py`.

**Critical note**: The diff shows upstream *deleting* our `MeshConfig`, `HybridRouterConfig`, device tool, etc. — but this is because upstream never had them. In the actual merge, our additions are **preserved** because they only exist on `main_embed`. Git's 3-way merge will keep them.

---

## Conflict Resolution Plan

### 1. `nanobot/channels/manager.py` (Low risk)

**What upstream changed**: 
- Channel manager restructured. Upstream added `send_progress`/`send_tool_hints` support to channels.
- Our mesh channel registration is the last block in `_init_channels()` (Lines 138-148 before merge).

**Resolution**: Accept upstream changes, re-append mesh channel block at end of `_init_channels()`. Pattern:
```python
# After all upstream channel registrations...
# --- embed_nanobot extensions ---
if config.channels.mesh.enabled:
    try:
        from nanobot.mesh.channel import MeshChannel
        mesh = MeshChannel(config=config, bus=self.bus)
        self.channels["mesh"] = mesh
        logger.info("Mesh channel registered")
    except ImportError:
        logger.warning("Mesh channel dependencies not installed")
```

### 2. `nanobot/cli/commands.py` (HIGH risk — most complex)

**What upstream changed**:
- `workspace/` → `nanobot/templates/` refactor: `_create_workspace_templates()` rewritten to use `importlib.resources`
- `gateway()` function significantly restructured: heartbeat config, progress streaming, bus routing for CLI
- `_make_provider()` cleanup
- Provider matching improvements
- Overall line count and structure shifted significantly

**Our code to preserve in `_make_provider()`** (currently L290-346):
```python
# Check for Hybrid Router first (custom feature)
hr = config.hybrid_router
if hr.enabled and hr.local_provider and hr.api_provider:
    from nanobot.providers.hybrid_router import HybridRouterProvider
    # ... local/api provider setup ...
    return HybridRouterProvider(...)
```

**Our code to preserve in `gateway()`** (currently L504-516):
```python
# --- embed_nanobot extensions: device control tool (task 2.3) ---
if "mesh" in channels.channels:
    try:
        from nanobot.agent.tools.device import DeviceControlTool
        mesh_ch = channels.channels["mesh"]
        agent.tools.register(DeviceControlTool(
            registry=mesh_ch.registry,
            transport=mesh_ch.transport,
            node_id=mesh_ch.node_id,
        ))
        console.print("[green]✓[/green] Device control tool registered")
        # --- embed_nanobot extensions: device-command routing (task 2.4) ---
        from nanobot.providers.hybrid_router import HybridRouterProvider
        if isinstance(provider, HybridRouterProvider):
            from nanobot.mesh.routing import build_force_local_fn
            provider.force_local_fn = build_force_local_fn(mesh_ch.registry)
            console.print("[green]✓[/green] Device-command routing → local LLM")
    except Exception as e:
        logger.warning(f"Device control tool not available: {e}")
```

**Resolution strategy**:
1. Accept ALL upstream changes first
2. Re-insert HybridRouter block at the TOP of `_make_provider()` (before upstream's Codex/Custom checks)
3. Re-insert DeviceControlTool + routing block in `gateway()` AFTER channels are started, BEFORE cron status display
4. Also handle: `workspace/` template references in `_create_workspace_templates` — upstream rewrote this, accept as-is

### 3. `pyproject.toml` (Low risk)

**Resolution**: Accept all upstream deps, re-append our `cryptography` dep at end:
```toml
    # --- embed_nanobot extensions: mesh encryption (task 1.11) ---
    "cryptography>=41.0.0",
```

---

## Post-Merge Checks Required

### A. BaseChannel Interface Change
`on_message()` gained `session_key: str | None = None` parameter. Our `MeshChannel` either:
- Overrides `on_message` directly → needs `session_key` param added
- Calls `super().on_message()` → pass-through should be fine with default

**Action**: Check `nanobot/mesh/channel.py` after merge, add `session_key` parameter if it overrides `on_message`.

### B. workspace/ → nanobot/templates/ Migration
Upstream moved template files. We still have `workspace/AGENTS.md`, `workspace/TOOLS.md` etc. in our branch.
- Upstream: `workspace/HEARTBEAT.md`, `workspace/SOUL.md`, `workspace/USER.md`, `workspace/memory/MEMORY.md` renamed to `nanobot/templates/...`
- Upstream: `workspace/AGENTS.md`, `workspace/TOOLS.md` deleted and content moved to `nanobot/templates/AGENTS.md`, `nanobot/templates/TOOLS.md`
- Our `workspace/` directory still has files — after merge the upstream-renamed files should be gone from `workspace/`, and the new `nanobot/templates/` files should exist.
- Verify `nanobot/templates/` exists after merge.

### C. Config Schema Compatibility
- `ollama` field may be removed from `ProvidersConfig` — check if auto-merge kept it
- Confirm `MeshConfig` and `HybridRouterConfig` still present
- Confirm `mesh` field in `ChannelsConfig`, `hybrid_router` field in `Config` still present
- New fields to note: `send_progress`, `send_tool_hints` (ChannelsConfig), `HeartbeatConfig` (in GatewayConfig), `volcengine` (ProvidersConfig), `reply_to_message` (TelegramConfig), `headers`/`tool_timeout` (MCPServerConfig)
- `AgentDefaults` changed: temperature 0.7→0.1, max_tool_iterations 20→40, memory_window 50→100

### D. LLMProvider Base Class Change
New static method `_sanitize_empty_content()` added. Our `HybridRouterProvider` inherits from `LLMProvider` — should be compatible (additive method).

### E. Agent Loop Refactoring
Memory consolidation extracted to `MemoryStore`. CLI routed through message bus. These shouldn't affect our code directly, but watch for import path changes.

### F. Test Compatibility
- Upstream added: `test_context_prompt_cache.py`, `test_cron_commands.py`, `test_cron_service.py`, `test_heartbeat_service.py`, `test_memory_consolidation_types.py`
- Our tests: `test_mesh.py`, `test_hybrid_router.py`, `test_automation.py`, `test_device_*.py`, `test_commands.py` — check all pass

---

## Key Upstream Features to Document

After merge, update docs for:
1. **VolcEngine provider** — new in registry + config
2. **Anthropic/OpenRouter prompt caching** (`cache_control`)
3. **Intermediate progress streaming** (`send_progress`, `send_tool_hints`)
4. **HeartbeatConfig** (moved from inline to dedicated config class)
5. **Telegram `reply_to_message`** config
6. **MCP `headers` + `tool_timeout`** config
7. **Feishu multimedia** (images, audio, files, share card)
8. **Slack thread-scoped sessions** + media upload
9. **Discord 2000-char splitting**
10. **`workspace/` → `nanobot/templates/`** migration
11. **Agent reliability**: behavioral constraints, default temperature 0.1, max_tool_iterations 40
12. **Provider matching**: explicit prefix wins over keyword

---

## Conflict Surface After Sync (Expected)

| File | Our Changes | Risk |
|------|-------------|------|
| `nanobot/config/schema.py` | MeshConfig, HybridRouterConfig, mesh/hybrid_router fields | Medium |
| `nanobot/channels/manager.py` | Mesh channel registration | Low |
| `nanobot/cli/commands.py` | HybridRouter in _make_provider, DeviceControlTool+routing in gateway | Medium |
| `nanobot/providers/__init__.py` | hybrid_router export | Low |
| `pyproject.toml` | cryptography dep | Low |
| `README.md` | embed_nanobot extensions section | Medium |

Note: `nanobot/providers/registry.py` removed from conflict surface — we have no custom modifications there.

---

## Git Commands for the Sync

```bash
# Already done:
# git fetch upstream
# git checkout main && git merge upstream/main --ff-only && git push origin main
# origin/main = upstream/main = 9e806d7

# To execute:
git checkout main_embed
git merge main     # Will produce 3 conflicts
# Resolve conflicts per plan above
git add -A
git commit -m "merge: upstream sync ce4f005..9e806d7 (276 commits: v0.1.4 era)"
# Run tests
python -m pytest tests/ -x
# Push
git push origin main_embed
```

---

## Convention Changes to Update in agent.md

1. **Loguru formatting**: Use `logger.info("message {}", var)` NOT `logger.info(f"message {var}")`
2. **workspace/ → nanobot/templates/**: Template files now packaged, not in workspace root
3. **Default temperature**: 0.1 (was 0.7)
4. **BaseChannel.on_message**: Now accepts `session_key` parameter
5. **LLMProvider**: Has `_sanitize_empty_content()` static method
6. **HeartbeatConfig**: Separate class in GatewayConfig
7. **ChannelsConfig**: Has `send_progress` and `send_tool_hints` fields
